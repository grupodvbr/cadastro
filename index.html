<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cadastro de Clientes</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{--bg:#0b0c10;--card:#131417;--line:#2a2f36;--txt:#f5f7fb;--muted:#cfd6e4;--brand:#22c55e;--brand2:#16a34a;--danger:#ef4444;--glass:rgba(255,255,255,.06);--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b0c10,#0f1116);color:var(--txt)}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(19,20,23,.85),rgba(19,20,23,.55));border-bottom:1px solid var(--glass)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px 16px;display:flex;gap:14px;align-items:center}
  header img{height:40px;width:auto;object-fit:contain}
  h1{margin:0;font-size:20px}
  .badge{margin-left:auto;font-size:12px;color:#9bb0c8;padding:6px 10px;border:1px solid var(--glass);border-radius:999px}
  main{max-width:1200px;margin:28px auto;padding:0 16px;display:grid;gap:22px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--glass);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card header{all:unset;display:block;padding:18px 18px 0 18px}
  .title{font-size:18px;font-weight:700;margin:0 0 4px}
  .subtitle{font-size:13px;color:var(--muted);margin:0 0 14px}
  form{padding:18px}
  .row{display:grid;grid-template-columns:1fr;gap:14px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  @media (max-width: 960px){.grid-2,.grid-3{grid-template-columns:1fr}}
  label{font-size:12px;color:#aeb8ca;display:block;margin:0 0 6px}
  .field{position:relative}
  input,select{width:100%;padding:12px;border:1px solid var(--glass);border-radius:12px;background:#0e1014;color:var(--txt);outline:none;transition:.2s}
  input::placeholder{color:#8f9bb0}
  input:focus{border-color:#3a485f;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
  fieldset{border:1px dashed var(--glass);border-radius:12px;padding:10px 12px;display:flex;gap:18px;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,.02)}
  fieldset legend{padding:0 6px;font-size:12px;color:#aeb8ca}
  .radio{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#dfe7f6}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:4px;padding:0 18px 18px}
  button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:10px}
  .primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#07270e}
  .ghost{background:#0e1014;color:var(--txt);border:1px solid var(--glass)}
  .statusbar{display:flex;align-items:center;gap:10px;padding:12px 18px;border-top:1px solid var(--glass);background:rgba(0,0,0,.2);font-size:13px;color:#afc4db}
  .dot{width:8px;height:8px;border-radius:999px;background:#6b7280}.dot.ok{background:var(--brand)}.dot.err{background:var(--danger)}
  .feedback{padding:12px 18px;border-top:1px solid var(--glass);background:rgba(0,0,0,.15);font-size:13px}
  .feedback .ok{color:#86efac}.feedback .err{color:#fecaca}

  .toast{position:fixed;right:16px;bottom:16px;background:#0e1014;color:#fff;border:1px solid var(--glass);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);transform:translateY(12px);opacity:0;pointer-events:none;transition:.25s;max-width:420px}
  .toast.show{transform:translateY(0);opacity:1}.toast .t{font-weight:700;margin-bottom:4px}.toast .m{font-size:13px;color:#cfd6e4}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <img src="LOGO_DO_SEU_NEGOCIO.png" alt="Logo"/>
    <h1>Cadastro de Clientes</h1>
    <span class="badge">Planilha: CLIENTES</span>
  </div>
</header>

<main>
  <section class="card">
    <header>
      <p class="title">Novo cliente</p>
      <p class="subtitle">Preencha e salve. O cadastro vai direto para a planilha e você recebe confirmação por e-mail.</p>
    </header>

    <form id="formCliente" autocomplete="off">
      <div class="row">
        <fieldset>
          <legend>Tipo de documento</legend>
          <label class="radio"><input type="radio" name="tipo" value="CPF" checked/> CPF</label>
          <label class="radio"><input type="radio" name="tipo" value="CNPJ"/> CNPJ</label>
        </fieldset>

        <div class="grid-2">
          <div class="field">
            <label id="lblDocumento" for="documento">CPF</label>
            <input id="documento" name="documento" inputmode="numeric" placeholder="000.000.000-00" maxlength="18" required/>
            <div id="docErro" style="color:#ef4444;font-size:12px;margin-top:6px;display:none"></div>
          </div>
          <div class="field">
            <label id="lblNome" for="nome">Nome completo</label>
            <input id="nome" name="nome" placeholder="Digite o nome completo" required/>
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="email">E-mail</label>
            <input id="email" name="email" type="email" placeholder="email@exemplo.com" required/>
          </div>
          <div class="field">
            <label for="nascimento">Data de nascimento</label>
            <input id="nascimento" name="nascimento" type="date"/>
          </div>
        </div>

        <fieldset>
          <legend>Endereço</legend>
          <div class="grid-3">
            <div class="field"><label for="cep">CEP</label><input id="cep" name="cep" inputmode="numeric" placeholder="00000-000" maxlength="9"/></div>
            <div class="field"><label for="uf">UF</label><input id="uf" name="uf" placeholder="BA" maxlength="2"/></div>
            <div class="field"><label for="cidade">Cidade</label><input id="cidade" name="cidade" placeholder="Salvador"/></div>
          </div>
          <div class="grid-2" style="margin-top:14px">
            <div class="field"><label for="logradouro">Endereço</label><input id="logradouro" name="logradouro" placeholder="Rua / Avenida"/></div>
            <div class="field"><label for="numero">Número</label><input id="numero" name="numero" placeholder="Nº"/></div>
          </div>
          <div class="grid-2" style="margin-top:14px">
            <div class="field"><label for="bairro">Bairro</label><input id="bairro" name="bairro" placeholder="Bairro"/></div>
            <div class="field"><label for="complemento">Complemento</label><input id="complemento" name="complemento" placeholder="Apto, bloco, ponto de ref."/></div>
          </div>
        </fieldset>

        <div class="actions">
          <button type="reset" class="ghost" id="btnReset">Limpar</button>
          <button type="submit" class="primary" id="btnSubmit"><span>Salvar</span></button>
        </div>
      </div>
    </form>

    <!-- Status de conexão -->
    <div class="statusbar">
      <span class="dot" id="connDot"></span>
      <span id="connText">Conectando…</span>
    </div>

    <!-- Retorno de confirmação / erro -->
    <div class="feedback" id="feedback" style="display:none">
      <span id="fbIcon">ℹ️</span>
      <span id="fbText">Mensagem</span>
    </div>
  </section>
</main>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="t" id="toastTitle">Tudo certo!</div>
  <div class="m" id="toastMsg">Cliente cadastrado com sucesso.</div>
</div>

<script>
  // ====== CONFIG ======
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbyYDEEbAlQ2PY3wVror3E3ZtLqn-i0kuy_Ndr4fGrBwE7Fgiei-1h2r5ltqZJy-oXC8/exec'; // troque pela sua URL /exec

  const qs = s => document.querySelector(s);
  const soNumeros = s => (s||'').replace(/\D+/g,'');

  // UI helpers
  function toast(t,m){const el=qs('#toast');qs('#toastTitle').textContent=t;qs('#toastMsg').textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3000)}
  function setConn(ok, txt){qs('#connDot').classList.toggle('ok',ok);qs('#connDot').classList.toggle('err',!ok);qs('#connText').textContent = txt || (ok?'Conectado à planilha':'Sem conexão')}
  function showFeedback(ok, msg){
    const fb = qs('#feedback'); const txt = qs('#fbText'); const ico = qs('#fbIcon');
    fb.style.display = 'block'; txt.textContent = msg;
    if(ok){ ico.textContent='✅'; txt.className='ok'; }
    else  { ico.textContent='❌'; txt.className='err'; }
  }

  // Masks
  function maskCPF(v){v=soNumeros(v).slice(0,11);if(v.length>9)return v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/,'$1.$2.$3-$4');if(v.length>6)return v.replace(/(\d{3})(\d{3})(\d{0,3})/,'$1.$2.$3');if(v.length>3)return v.replace(/(\d{3})(\d{0,3})/,'$1.$2');return v}
  function maskCNPJ(v){v=soNumeros(v).slice(0,14);if(v.length>12)return v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/,'$1.$2.$3/$4-$5');if(v.length>8)return v.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/,'$1.$2.$3/$4');if(v.length>5)return v.replace(/(\d{2})(\d{3})(\d{0,3})/,'$1.$2.$3');if(v.length>2)return v.replace(/(\d{2})(\d{0,3})/,'$1.$2');return v}
  function maskCEP(v){v=soNumeros(v).slice(0,8);if(v.length>5)return v.replace(/(\d{5})(\d{0,3})/,'$1-$2');return v}

  // Form behavior
  const tipoRadios = document.querySelectorAll('input[name="tipo"]');
  const documento=qs('#documento'), lblDocumento=qs('#lblDocumento'), lblNome=qs('#lblNome'),
        nascimentoWrap=qs('#nascimentoWrap'), docErro=qs('#docErro'), cep=qs('#cep'), btnSubmit=qs('#btnSubmit');

  function setTipo(tipo){
    if (tipo==='CNPJ'){lblDocumento.textContent='CNPJ';documento.placeholder='00.000.000/0000-00';lblNome.textContent='Razão social';nascimentoWrap.style.display='none';documento.value=maskCNPJ(documento.value)}
    else{lblDocumento.textContent='CPF';documento.placeholder='000.000.000-00';lblNome.textContent='Nome completo';nascimentoWrap.style.display='grid';documento.value=maskCPF(documento.value)}
    validarDocumento();
  }
  function validarDocumento(){
    const t=document.querySelector('input[name="tipo"]:checked').value;
    const d=soNumeros(documento.value);
    let ok=false,msg='';
    if(t==='CPF'){ok=d.length===11; if(!ok) msg='CPF deve ter 11 dígitos.'}
    else{ok=d.length===14; if(!ok) msg='CNPJ deve ter 14 dígitos.'}
    docErro.style.display = ok ? 'none' : 'block';
    docErro.textContent = msg; return ok;
  }

  tipoRadios.forEach(r=>r.addEventListener('change',e=>setTipo(e.target.value)));
  documento.addEventListener('input',()=>{const t=document.querySelector('input[name="tipo"]:checked').value;documento.value=(t==='CNPJ')?maskCNPJ(documento.value):maskCPF(documento.value);validarDocumento()});
  cep.addEventListener('input',()=>{cep.value=maskCEP(cep.value)});

  // CEP autofill (ViaCEP)
  async function tryFillAddress(){
    const c=soNumeros(cep.value); if(c.length!==8) return;
    try{
      const r=await fetch(`https://viacep.com.br/ws/${c}/json/`); if(!r.ok) return;
      const j=await r.json(); if(j.erro) return;
      qs('#uf').value=j.uf||qs('#uf').value;
      qs('#cidade').value=j.localidade||qs('#cidade').value;
      qs('#logradouro').value=j.logradouro||qs('#logradouro').value;
      qs('#bairro').value=j.bairro||qs('#bairro').value;
    }catch(_){}
  }
  cep.addEventListener('blur',tryFillAddress);

  // PRÉ-CHECAGEM de duplicado no submit
  document.getElementById('formCliente').addEventListener('submit', async (e)=>{
    e.preventDefault(); if(!validarDocumento()) return;

    const form = new FormData(e.target);
    const tipo = document.querySelector('input[name="tipo"]:checked').value;
    const documentoDigits = soNumeros(form.get('documento') || '');

    // 1) checa no GAS se já existe
    try{
      const check = await fetch(`${GAS_URL}?doc=${documentoDigits}`);
      const j = await check.json();
      if (j && j.ok) {
        showFeedback(false, 'Documento já cadastrado. Não é permitido duplicar.');
        toast('Documento duplicado', 'Este CPF/CNPJ já existe na planilha.');
        return;
      }
    }catch(_){} // se falhar a checagem, seguimos para o POST (o GAS também bloqueia)

    // 2) monta e envia POST (urlencoded)
    const data = Object.fromEntries(form.entries());
    data.tipo = tipo;
    data.documento = documentoDigits;

    const body = new URLSearchParams(data).toString();

    btnSubmit.disabled = true; btnSubmit.innerHTML='<span>Salvando…</span>';
    try{
      const resp = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body });
      const j = await resp.json();
      if(j && j.ok){
        const msg = j.msg || 'Cliente cadastrado.';
        toast('Tudo certo!', msg);
        showFeedback(true, msg);
        e.target.reset(); setTipo('CPF');
      }else{
        const err = (j && j.error) ? String(j.error) : 'Falha ao salvar';
        showFeedback(false, err);
        toast('Erro ao salvar', err);
      }
    }catch(err){
      showFeedback(false, String(err.message||err));
      toast('Erro ao salvar', String(err.message||err));
    }finally{
      btnSubmit.disabled=false; btnSubmit.innerHTML='<span>Salvar</span>';
    }
  });

  // Ping inicial (mostra se está conectado)
  (async function ping(){
    try{
      const r=await fetch(`${GAS_URL}?ping=1`);
      if(r.ok){
        const t = await r.text();
        setConn(true, t==='pong' ? 'Conectado à planilha' : 'Online');
      }else{
        setConn(false, 'Sem conexão');
      }
    }catch(_){
      setConn(false, 'Sem conexão');
    }
  })();

  qs('#btnReset').addEventListener('click', ()=>setTipo('CPF'));
  setTipo('CPF');
</script>
</body>
</html>
