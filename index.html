<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1"/>
<title>Cadastro de Clientes</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{--bg:#0b0c10;--card:#131417;--line:#2a2f36;--txt:#f5f7fb;--muted:#cfd6e4;--brand:#22c55e;--brand2:#16a34a;--danger:#ef4444;--glass:rgba(255,255,255,.06);--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b0c10,#0f1116);color:var(--txt)}
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(19,20,23,.85),rgba(19,20,23,.55));border-bottom:1px solid var(--glass)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px 16px;display:flex;gap:14px;align-items:center}
  header img{height:40px;width:auto;object-fit:contain}
  h1{margin:0;font-size:20px}
  .badge{margin-left:auto;font-size:12px;color:#9bb0c8;padding:6px 10px;border:1px solid var(--glass);border-radius:999px}

  main{max-width:1200px;margin:28px auto;padding:0 16px;display:grid;gap:22px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--glass);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card header{all:unset;display:block;padding:18px 18px 0 18px}
  .title{font-size:18px;font-weight:700;margin:0 0 4px}
  .subtitle{font-size:13px;color:var(--muted);margin:0 0 14px}

  form{padding:18px}
  .row{display:grid;grid-template-columns:1fr;gap:14px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  @media (max-width: 960px){.grid-2,.grid-3{grid-template-columns:1fr}}

  label{font-size:12px;color:#aeb8ca;display:block;margin:0 0 6px}
  .field{position:relative}
  input,select{width:100%;padding:12px;border:1px solid var(--glass);border-radius:12px;background:#0e1014;color:var(--txt);outline:none;transition:.2s}
  input::placeholder{color:#8f9bb0}
  input:focus{border-color:#3a485f;box-shadow:0 0 0 4px rgba(59,130,246,.12)}
  fieldset{border:1px dashed var(--glass);border-radius:12px;padding:10px 12px;display:flex;gap:18px;align-items:center;flex-wrap:wrap;background:rgba(255,255,255,.02)}
  fieldset legend{padding:0 6px;font-size:12px;color:#aeb8ca}
  .radio{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:#dfe7f6}

  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:4px;padding:0 18px 18px}
  button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:10px}
  .primary{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#07270e}
  .ghost{background:#0e1014;color:var(--txt);border:1px solid var(--glass)}

  .statusbar{display:flex;align-items:center;gap:10px;padding:12px 18px;border-top:1px solid var(--glass);background:rgba(0,0,0,.2);font-size:13px;color:#afc4db}
  .dot{width:8px;height:8px;border-radius:999px;background:#6b7280}.dot.ok{background:var(--brand)}.dot.err{background:var(--danger)}
  .feedback{padding:12px 18px;border-top:1px solid var(--glass);background:rgba(0,0,0,.15);font-size:13px}
  .feedback .ok{color:#86efac}.feedback .err{color:#fecaca}

  .toast{position:fixed;right:16px;bottom:16px;background:#0e1014;color:#fff;border:1px solid var(--glass);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);transform:translateY(12px);opacity:0;pointer-events:none;transition:.25s;max-width:420px}
  .toast.show{transform:translateY(0);opacity:1}.toast .t{font-weight:700;margin-bottom:4px}.toast .m{font-size:13px;color:#cfd6e4}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay.show{display:flex}
  .spinner{width:44px;height:44px;border:4px solid #ffffff40;border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* WhatsApp */
  .whats-wrap{display:none; padding:14px 18px; border-top:1px solid var(--glass); background:rgba(0,0,0,.15)}
  .whats-btn{background:linear-gradient(180deg,#25D366,#1fa955); color:#042810; border:0; border-radius:12px; padding:12px 16px; font-weight:800; display:inline-flex; align-items:center; gap:10px; cursor:pointer}
  .whats-btn svg{width:18px;height:18px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <img src="https://github.com/grupodvbr/cadastro/blob/main/paste/ChatGPT%20Image%2030%20de%20jun.%20de%202025,%2011_55_51.png?raw=true" alt="Logo"/>
    <h1>Cadastro de Clientes</h1>
    <span class="badge">MERCATTO DELÍCIA</span>
  </div>
</header>

<main>
  <section class="card">
    <header>
      <p class="title">Novo cliente</p>
      <p class="subtitle">Preencha e salve. O cadastro vai direto para a planilha e você recebe confirmação por e-mail.</p>
    </header>

    <form id="formCliente" autocomplete="off" novalidate>
      <div class="row">
        <fieldset>
          <legend>Tipo de documento</legend>
          <label class="radio"><input type="radio" name="tipo" value="CPF" checked/> CPF</label>
          <label class="radio"><input type="radio" name="tipo" value="CNPJ"/> CNPJ</label>
        </fieldset>

        <div class="grid-2">
          <div class="field">
            <label id="lblDocumento" for="documento">CPF</label>
            <input id="documento" name="documento" inputmode="numeric" pattern="[0-9]*" placeholder="000.000.000-00" maxlength="18" required/>
            <div id="docErro" style="color:#ef4444;font-size:12px;margin-top:6px;display:none"></div>
          </div>
          <div class="field">
            <label id="lblNome" for="nome">Nome completo</label>
            <input id="nome" name="nome" placeholder="Digite o nome completo" required/>
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="email">E-mail</label>
            <!-- email com limpeza e regex amigável -->
            <input id="email" name="email" type="text" inputmode="email" spellcheck="false"
                   placeholder="email@exemplo.com" required
                   pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$"/>
            <div id="emailErro" style="color:#ef4444;font-size:12px;margin-top:6px;display:none"></div>
          </div>
          <div class="field">
            <label for="nascimento">Data de nascimento</label>
            <input id="nascimento" name="nascimento" type="date"/>
          </div>
        </div>

        <fieldset>
          <legend>Endereço</legend>
          <div class="grid-3">
            <div class="field"><label for="cep">CEP</label><input id="cep" name="cep" inputmode="numeric" pattern="[0-9]*" placeholder="00000-000" maxlength="9"/></div>
            <div class="field"><label for="uf">UF</label><input id="uf" name="uf" placeholder="BA" maxlength="2" style="text-transform:uppercase"/></div>
            <div class="field"><label for="cidade">Cidade</label><input id="cidade" name="cidade" placeholder="Salvador"/></div>
          </div>
          <div class="grid-2" style="margin-top:14px">
            <div class="field"><label for="logradouro">Endereço</label><input id="logradouro" name="logradouro" placeholder="Rua / Avenida"/></div>
            <div class="field"><label for="numero">Número</label><input id="numero" name="numero" inputmode="numeric" pattern="[0-9]*" placeholder="Nº"/></div>
          </div>
          <div class="grid-2" style="margin-top:14px">
            <div class="field"><label for="bairro">Bairro</label><input id="bairro" name="bairro" placeholder="Bairro"/></div>
            <div class="field"><label for="complemento">Complemento</label><input id="complemento" name="complemento" placeholder="Apto, bloco, ponto de ref."/></div>
          </div>
        </fieldset>

        <div class="actions">
          <button type="reset" class="ghost" id="btnReset">Limpar</button>
          <button type="submit" class="primary" id="btnSubmit"><span>Salvar</span></button>
        </div>
      </div>
    </form>

    <div class="statusbar">
      <span class="dot" id="connDot"></span>
      <span id="connText">Conectando…</span>
    </div>

    <div class="feedback" id="feedback" style="display:none">
      <span id="fbIcon">ℹ️</span>
      <span id="fbText">Mensagem</span>
    </div>

    <!-- WhatsApp -->
    <div class="whats-wrap" id="whatsWrap" aria-live="polite">
      <button class="whats-btn" id="btnWhats" type="button">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M20.52 3.48A11.9 11.9 0 0 0 12.06 0C5.46 0 .12 5.34.12 11.94c0 2.1.54 4.14 1.56 5.94L0 24l6.3-1.62c1.74.96 3.72 1.46 5.76 1.46 6.6 0 11.94-5.34 11.94-11.94 0-3.18-1.26-6.18-3.48-8.42ZM12.06 22.2c-1.8 0-3.54-.48-5.1-1.38l-.36-.18-3.72.96.96-3.6-.24-.36a10.18 10.18 0 0 1-1.62-5.7c0-5.64 4.62-10.26 10.26-10.26 2.76 0 5.34 1.08 7.26 3 1.92 1.92 3 4.5 3 7.26 0 5.64-4.62 10.26-10.26 10.26Zm5.94-7.62c-.3-.18-1.8-.9-2.1-1-.3-.12-.54-.18-.78.18-.24.36-.9 1-.9 1.2s-.18.24-.36.06c-.18-.18-.78-.3-1.5-.96-.54-.48-.9-1.08-1.02-1.26-.24-.24-.06-.36.12-.54.12-.12.24-.3.36-.48.12-.18.18-.3.3-.48.12-.18.06-.36-.06-.54-.12-.18-.78-1.86-1.08-2.58-.3-.72-.6-.6-.78-.6h-.66c-.24 0-.54.06-.84.36s-1.08 1.02-1.08 2.46 1.14 2.82 1.32 3 .66 1.26 1.62 2.16c.96.9 2.52 1.74 2.88 1.92.36.18.72.18 1 .12.3-.06 1-.42 1.14-.84.12-.42.12-.78.06-.84-.06-.06-.24-.12-.54-.3Z"/>
        </svg>
        Continuar no WhatsApp
      </button>
    </div>
    <!-- /WhatsApp -->
  </section>
</main>

<div class="toast" id="toast">
  <div class="t" id="toastTitle">Tudo certo!</div>
  <div class="m" id="toastMsg">Cliente cadastrado com sucesso.</div>
</div>

<div id="overlay" class="overlay" aria-hidden="true">
  <div class="spinner" role="status" aria-label="Carregando"></div>
</div>

<script>
  // ====== CONFIG ======
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbz0IJlBql79zMdk8PxExyHd6BYMW4a0gyAHDLakedsSozFopUGu9GiAIkvnqsGkIn1L/exec';
  // WhatsApp: número fixo opcional (DDI+DDD+numero) ex.: '5571XXXXXXXX'
  const WHATSAPP_NUMBER = '';

  const qs = s => document.querySelector(s);
  const soNumeros = s => (s||'').replace(/\D+/g,'');

  // UI helpers
  function toast(t,m){const el=qs('#toast');qs('#toastTitle').textContent=t;qs('#toastMsg').textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3000)}
  function setConn(ok, txt){qs('#connDot').classList.toggle('ok',ok);qs('#connDot').classList.toggle('err',!ok);qs('#connText').textContent = txt || (ok?'Online':'Sem conexão')}
  function showFeedback(ok, msg){
    const fb = qs('#feedback'); const txt = qs('#fbText'); const ico = qs('#fbIcon');
    fb.style.display = 'block'; txt.textContent = msg;
    if(ok){ ico.textContent='✅'; txt.className='ok'; } else { ico.textContent='❌'; txt.className='err'; }
  }
  const overlay = qs('#overlay');
  function showOverlay(){ overlay.classList.add('show'); document.body.style.pointerEvents='none'; }
  function hideOverlay(){ overlay.classList.remove('show'); document.body.style.pointerEvents=''; }

  // Masks
  function maskCPF(v){v=soNumeros(v).slice(0,11);if(v.length>9)return v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/,'$1.$2.$3-$4');if(v.length>6)return v.replace(/(\d{3})(\d{3})(\d{0,3})/,'$1.$2.$3');if(v.length>3)return v.replace(/(\d{3})(\d{0,3})/,'$1.$2');return v}
  function maskCNPJ(v){v=soNumeros(v).slice(0,14);if(v.length>12)return v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/,'$1.$2.$3/$4-$5');if(v.length>8)return v.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/,'$1.$2.$3/$4');if(v.length>5)return v.replace(/(\d{2})(\d{3})(\d{0,3})/,'$1.$2.$3');if(v.length>2)return v.replace(/(\d{2})(\d{0,3})/,'$1.$2');return v}
  function maskCEP(v){v=soNumeros(v).slice(0,8);if(v.length>5)return v.replace(/(\d{5})(\d{0,3})/,'$1-$2');return v}

  // Form behavior
  const tipoRadios = document.querySelectorAll('input[name="tipo"]');
  const documento=qs('#documento'), lblDocumento=qs('#lblDocumento'), lblNome=qs('#lblNome'),
        docErro=qs('#docErro'), cep=qs('#cep'), btnSubmit=qs('#btnSubmit'),
        email=qs('#email'), emailErro=qs('#emailErro');

  function setTipo(tipo){
    if (tipo==='CNPJ'){lblDocumento.textContent='CNPJ';documento.placeholder='00.000.000/0000-00';documento.value=maskCNPJ(documento.value);lblNome.textContent='Razão social';}
    else{lblDocumento.textContent='CPF';documento.placeholder='000.000.000-00';documento.value=maskCPF(documento.value);lblNome.textContent='Nome completo';}
    validarDocumento();
  }
  function validarDocumento(){
    const t=document.querySelector('input[name="tipo"]:checked').value;
    const d=soNumeros(documento.value);
    let ok=false,msg='';
    if(t==='CPF'){ok=d.length===11; if(!ok) msg='CPF deve ter 11 dígitos.'}
    else{ok=d.length===14; if(!ok) msg='CNPJ deve ter 14 dígitos.'}
    docErro.style.display = ok ? 'none' : 'block';
    docErro.textContent = msg; return ok;
  }
  tipoRadios.forEach(r=>r.addEventListener('change',e=>setTipo(e.target.value)));
  documento.addEventListener('input',()=>{const t=document.querySelector('input[name="tipo"]:checked').value;documento.value=(t==='CNPJ')?maskCNPJ(documento.value):maskCPF(documento.value);validarDocumento()});
  cep.addEventListener('input',()=>{cep.value=maskCEP(cep.value)});

  // CEP autofill
  async function tryFillAddress(){
    const c=soNumeros(cep.value); if(c.length!==8) return;
    try{
      const r=await fetch(`https://viacep.com.br/ws/${c}/json/`); if(!r.ok) return;
      const j=await r.json(); if(j.erro) return;
      qs('#uf').value=(j.uf||'').toUpperCase() || qs('#uf').value;
      qs('#cidade').value=j.localidade || qs('#cidade').value;
      qs('#logradouro').value=j.logradouro || qs('#logradouro').value;
      qs('#bairro').value=j.bairro || qs('#bairro').value;
    }catch(_){}
  }
  cep.addEventListener('blur',tryFillAddress);

  // ====== E-MAIL: limpeza + validação amigável ======
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
  function sanitizeEmail(){ email.value = email.value.trim().toLowerCase(); }
  function validarEmail(){
    sanitizeEmail();
    const ok = emailRegex.test(email.value);
    emailErro.style.display = ok ? 'none' : 'block';
    emailErro.textContent = ok ? '' : 'Digite um e-mail válido (ex.: nome@dominio.com).';
    return ok;
  }
  email.addEventListener('input', validarEmail);
  email.addEventListener('blur', validarEmail);

  // WhatsApp helpers
  function montarMensagemWhats(data){
    const nome = (data.nome||'').trim();
    const t = `Olá ${nome?nome:''}! Seu cadastro foi concluído ✅%0A%0APosso te ajudar com mais alguma coisa?`;
    const base = 'https://wa.me/';
    return WHATSAPP_NUMBER ? `${base}${WHATSAPP_NUMBER}?text=${t}` : `${base}?text=${t}`;
  }
  function mostrarBotaoWhats(url){
    const box = qs('#whatsWrap'); const btn = qs('#btnWhats');
    btn.onclick = () => window.open(url, '_blank', 'noopener');
    box.style.display = 'block';
  }
  function esconderBotaoWhats(){
    const box = qs('#whatsWrap'); const btn = qs('#btnWhats');
    btn.onclick = null; box.style.display = 'none';
  }

  // SUBMIT
  document.getElementById('formCliente').addEventListener('submit', async (e)=>{
    e.preventDefault();

    const docOK = validarDocumento();
    const emailOK = validarEmail();
    if(!docOK || !emailOK){
      if(!emailOK) email.focus();
      return;
    }

    const form = new FormData(e.target);
    const tipo = document.querySelector('input[name="tipo"]:checked').value;
    const documentoDigits = soNumeros(form.get('documento') || '');
    const data = Object.fromEntries(form.entries());
    data.tipo = tipo; data.documento = documentoDigits;
    data.email = (data.email||'').trim().toLowerCase();

    esconderBotaoWhats();

    showOverlay(); btnSubmit.disabled=true; btnSubmit.innerHTML='<span>Salvando…</span>';
    try{
      // pré-checagem duplicado
      try{
        const check = await fetch(`${GAS_URL}?doc=${documentoDigits}`);
        const j = await check.json();
        if (j && j.ok) {
          showFeedback(false, 'Documento já cadastrado. Não é permitido duplicar.');
          toast('Documento duplicado', 'Este CPF/CNPJ já existe na planilha.');
          return;
        }
      }catch(_){}

      // envia POST
      const body = new URLSearchParams(data).toString();
      const resp = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body });
      const j = await resp.json();
      if(j && j.ok){
        const msg = j.msg || 'Cliente cadastrado.';
        toast('Tudo certo!', msg);
        showFeedback(true, msg);

        const waUrl = montarMensagemWhats(data);
        mostrarBotaoWhats(waUrl);

        e.target.reset(); setTipo('CPF'); emailErro.style.display='none';
      }else{
        const err = (j && j.error) ? String(j.error) : 'Falha ao salvar';
        showFeedback(false, err);
        toast('Erro ao salvar', err);
      }
    }catch(err){
      showFeedback(false, String(err.message||err));
      toast('Erro ao salvar', String(err.message||err));
    }finally{
      hideOverlay(); btnSubmit.disabled=false; btnSubmit.innerHTML='<span>Salvar</span>';
    }
  });

  // Ping inicial
  (async function ping(){
    try{
      const r=await fetch(`${GAS_URL}?ping=1`);
      if(r.ok){
        const t = await r.text();
        setConn(true, t==='pong' ? 'Online' : 'Online');
      }else{
        setConn(false, 'Sem conexão');
      }
    }catch(_){
      setConn(false, 'Sem conexão');
    }
  })();

  qs('#btnReset').addEventListener('click', ()=>{
    setTipo('CPF');
    esconderBotaoWhats();
    emailErro.style.display='none';
  });
  setTipo('CPF');
</script>
</body>
</html>
